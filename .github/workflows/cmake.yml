name: CMake

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  TEST_RUN_TARGET: ninja-release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Prepare host
      run: |
        sudo apt-get update -qq
        sudo apt-get install ninja-build

    - name: Submodules
      run: git submodule update --init deps/vcpkg

    - uses: lukka/get-cmake@latest

    - name: Setup vcpkg env
      uses: lukka/run-vcpkg@v10
      with:
        vcpkgDirectory: '${{ github.workspace }}/deps/vcpkg'
        vcpkgJsonGlob: '${{ github.workspace }}/vcpkg.json'
        runVcpkgInstall: true

    - name: CMake configure and build
      uses: lukka/run-cmake@v10
      with:
        configurePreset: '${{env.TEST_RUN_TARGET}}'
        buildPreset: '${{env.TEST_RUN_TARGET}}'

    - name: metsi-simlib unit tests
      run: ctest --test-dir ${{github.workspace}}/builds/${{env.TEST_RUN_TARGET}}/metsi-simlib --output-on-failure

    - name: metsi-app unit tests
      run: ctest --test-dir ${{github.workspace}}/builds/${{env.TEST_RUN_TARGET}}/metsi-app --output-on-failure


